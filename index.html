<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生成績查詢系統</title>
    <!-- 使用 Tailwind CSS 進行切版 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 使用 FontAwesome 增加圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .score-card {
            transition: all 0.3s ease;
        }
        .score-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* 表格響應式優化 */
        .table-cell-p { padding: 0.75rem; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4">

    <!-- 標題區 -->
    <header class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            <i class="fa-solid fa-graduation-cap text-blue-600 mr-2"></i>學生成績查詢系統
        </h1>
        <p class="text-gray-500">請輸入資料查詢評量成績</p>
    </header>

    <!-- 登入與查詢區 -->
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md" id="loginParams">
        
        <!-- 載入中遮罩 (初始載入選單時) -->
        <div id="initLoader" class="flex justify-center items-center py-4">
            <div class="loader mr-3"></div>
            <span class="text-gray-600">正在讀取考試列表...</span>
        </div>

        <div id="queryForm" class="hidden space-y-4">
            <!-- 評量選擇 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">選擇評量</label>
                <div class="relative">
                    <select id="sheetSelect" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 border rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm shadow-sm transition">
                        <option value="" disabled selected>請選擇一次評量</option>
                    </select>
                </div>
            </div>

            <!-- 身分證輸入 -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">身分證字號 (後五碼)</label>
                <input type="password" id="idInput" maxlength="5" placeholder="例如: 12345" 
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm tracking-widest text-center">
            </div>

            <!-- 查詢按鈕 -->
            <button onclick="performQuery()" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition">
                查詢成績
            </button>
        </div>

        <!-- 錯誤訊息 -->
        <div id="errorMsg" class="hidden mt-4 p-3 bg-red-50 text-red-700 rounded-md text-sm text-center"></div>
    </div>

    <!-- 結果顯示區 (隱藏) -->
    <div id="resultArea" class="hidden w-full max-w-5xl mt-8 animate-fade-in-up">
        
        <!-- 學生基本資料卡 -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-6 flex justify-between items-center border-l-4 border-blue-500">
            <div>
                <h2 class="text-xl font-bold text-gray-800" id="resTitle">第一學期第一次評量</h2>
                <div class="mt-2 text-gray-600 space-x-4">
                    <span><i class="fa-solid fa-chair mr-1"></i>座號: <strong id="resSeat" class="text-gray-900">--</strong></span>
                    <span><i class="fa-solid fa-user mr-1"></i>姓名: <strong id="resName" class="text-gray-900">--</strong></span>
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-500">總平均</div>
                <div id="resAvg" class="text-3xl font-bold text-blue-600">--</div>
            </div>
        </div>

        <!-- 成績總表 -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden mb-8">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700">成績明細與全班統計</h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10">科目</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">定期成績</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">平時成績</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-blue-600 uppercase tracking-wider bg-blue-50">班級平均 (定期)</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-green-600 uppercase tracking-wider bg-green-50">班級高標 (定期)</th>
                        </tr>
                    </thead>
                    <tbody id="scoreTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- JS 動態生成 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 組距分析 -->
        <h3 class="text-xl font-bold text-gray-800 mb-4 px-2"><i class="fa-solid fa-chart-bar mr-2 text-blue-500"></i>定期成績組距分析</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="distGrid">
            <!-- JS 動態生成組距卡片 -->
        </div>

        <!-- 返回按鈕 -->
        <div class="mt-8 text-center">
            <button onclick="resetQuery()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition">
                <i class="fa-solid fa-rotate-left mr-2"></i>重新查詢
            </button>
        </div>

    </div>

    <!-- JS 邏輯 -->
    <script>
        // *** 重要：請在此填入您的 Google Apps Script 網址 ***
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxnktng5IgUFvGhZPvw9Vtnj7Qq8evWeOZDo4q9MMtWAOCNFKy6nCq055qGLWZdnDRcLg/exec"; 

        const SUBJECT_KEYS = ['chi', 'eng', 'math', 'soc', 'sci'];
        const SUBJECT_NAMES = { 'chi': '國語', 'eng': '英語', 'math': '數學', 'soc': '社會', 'sci': '自然' };

        // 頁面載入時取得工作表清單
        document.addEventListener('DOMContentLoaded', async () => {
            const loader = document.getElementById('initLoader');
            const form = document.getElementById('queryForm');
            const select = document.getElementById('sheetSelect');
            const errorArea = document.getElementById('errorMsg');

            if (SCRIPT_URL.includes("XXXXXXXXXXXX")) {
                showError("請先設定 index.html 內的 SCRIPT_URL 變數！");
                loader.classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(`${SCRIPT_URL}?op=get_sheets`);
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    data.forEach(sheet => {
                        const option = document.createElement('option');
                        option.value = sheet;
                        option.textContent = sheet;
                        select.appendChild(option);
                    });
                    loader.classList.add('hidden');
                    form.classList.remove('hidden');
                } else {
                    throw new Error("格式錯誤");
                }
            } catch (e) {
                console.error(e);
                loader.classList.add('hidden');
                showError("無法讀取評量清單，請檢查網路或 Script 設定。");
            }
        });

        async function performQuery() {
            const sheet = document.getElementById('sheetSelect').value;
            const idLast5 = document.getElementById('idInput').value;
            const btn = document.querySelector('button[onclick="performQuery()"]');
            
            if (!sheet) { alert('請選擇評量'); return; }
            if (idLast5.length !== 5) { alert('請輸入完整的身分證後五碼'); return; }

            // UI Loading 狀態
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>查詢中...';
            btn.disabled = true;
            hideError();

            try {
                const url = `${SCRIPT_URL}?op=query&sheet_name=${encodeURIComponent(sheet)}&id_last5=${encodeURIComponent(idLast5)}`;
                
                // 使用 fetch 呼叫 GAS
                const response = await fetch(url);
                
                // 處理轉址 (GitHub Pages 呼叫 GAS 有時會遇到 CORS 或 redirect，通常 fetch 會自動處理 redirect)
                // 如果遇到 CORS 錯誤，通常是因為 GAS 發生錯誤回傳了 HTML 而非 JSON
                
                const json = await response.json();

                if (json.error) {
                    showError(json.error);
                } else {
                    renderResult(sheet, json);
                }

            } catch (e) {
                console.error(e);
                showError("查詢失敗，請稍後再試。");
            } finally {
                btn.innerHTML = '查詢成績';
                btn.disabled = false;
            }
        }

        function renderResult(sheetName, data) {
            const student = data.student;
            const stats = data.stats;

            // 1. 填寫基本資料
            document.getElementById('resTitle').textContent = sheetName;
            document.getElementById('resSeat').textContent = student.seat;
            document.getElementById('resName').textContent = student.name;
            document.getElementById('resAvg').textContent = student.scores.avg;

            // 2. 填寫表格
            const tbody = document.getElementById('scoreTableBody');
            tbody.innerHTML = '';

            SUBJECT_KEYS.forEach(key => {
                const sData = student.scores[key];
                const sStats = stats[key];
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 sticky left-0 bg-white">${SUBJECT_NAMES[key]}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-700 font-medium">${sData.exam}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">${sData.reg}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-blue-600 bg-blue-50 font-bold">${sStats.avg}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-green-600 bg-green-50 font-bold">${sStats.highStd}</td>
                `;
                tbody.appendChild(tr);
            });

            // 3. 填寫組距卡片
            const distGrid = document.getElementById('distGrid');
            distGrid.innerHTML = '';

            SUBJECT_KEYS.forEach(key => {
                const dist = stats[key].distribution;
                const ranges = [
                    { label: '100分', key: '100', color: 'bg-indigo-100 text-indigo-800' },
                    { label: '90-99分', key: '90-99', color: 'bg-blue-100 text-blue-800' },
                    { label: '80-89分', key: '80-89', color: 'bg-green-100 text-green-800' },
                    { label: '70-79分', key: '70-79', color: 'bg-yellow-100 text-yellow-800' },
                    { label: '60-69分', key: '60-69', color: 'bg-orange-100 text-orange-800' },
                    { label: '60分以下', key: '<60', color: 'bg-red-100 text-red-800' },
                ];

                let rowsHtml = '';
                ranges.forEach(r => {
                    const count = dist[r.key];
                    if (count > 0 || true) { // 顯示所有區間
                        rowsHtml += `
                            <div class="flex justify-between items-center text-sm py-1 border-b border-gray-100 last:border-0">
                                <span class="px-2 py-0.5 rounded-full text-xs font-medium ${r.color}">${r.label}</span>
                                <span class="font-bold text-gray-700">${count} 人</span>
                            </div>
                        `;
                    }
                });

                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-lg shadow border border-gray-100 score-card";
                card.innerHTML = `
                    <h4 class="font-bold text-gray-800 mb-3 border-b pb-2 flex justify-between">
                        <span>${SUBJECT_NAMES[key]}</span>
                        <span class="text-xs text-gray-500 font-normal self-end">定期評量分佈</span>
                    </h4>
                    <div class="space-y-1">
                        ${rowsHtml}
                    </div>
                `;
                distGrid.appendChild(card);
            });

            // 切換視圖
            document.getElementById('loginParams').classList.add('hidden');
            document.getElementById('resultArea').classList.remove('hidden');
        }

        function resetQuery() {
            document.getElementById('resultArea').classList.add('hidden');
            document.getElementById('loginParams').classList.remove('hidden');
            document.getElementById('idInput').value = '';
            document.getElementById('errorMsg').classList.add('hidden');
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMsg').classList.add('hidden');
        }
    </script>
</body>
</html>
